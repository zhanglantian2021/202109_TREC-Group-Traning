##???Ա????????κ????ʡ???????��ϵ???ˣ? ??˪???п?Ժ??̬?????о????ģ?shuangzhang@rcees.ac.cn
##��ϰ????��Դ??Ben??tez-L??pez, A., R. Alkemade, A. M. Schipper, D. J. Ingram, P. A. Verweij, J. A. J. Eikelboom, and M. A. J. Huijbregts. 2017. The impact of hunting on tropical mammal and bird populations. Science 356:180-183.
##Ϊ?˱???��ϰ????ԭ?????к???ȱʧֵ????????ȫ??ɾȥ???ش?˵??
##???ù???Ŀ¼
setwd("C:/Users/yrq/Desktop/Meta introduce_YRQ/data")
##????????
##?????ܹ?ֱ?Ӷ?ȡexcel?ļ??İ???readxl
library(readxl)
require(ggmap)
require(maps)

d0 <- read_excel("Benitez-Lopez_et_al._2017_Science.xlsx")

mapWorld <- borders("world", colour="gray50", fill="gray65") # create a layer of borders
mp <- ggplot() + theme_bw()+  mapWorld+xlab("Longitude") + ylab("Latitude")+
  theme(axis.text=element_text(size=16,face="bold", color="black"),
        axis.title=element_text(size=16,face="bold"))
mp <- mp+ geom_point(data=d0 , aes(x=longitude, y=latitude), size=2, color="red")
mp




#####????Ҫ?????İ???????

d1 <- read_excel("meta_sampledata.xls")

##?鿴????
View(d1)
variable.names(d1)
##????
## d1 <- read.csv("meta_sampledata.csv")

##????Ҫ?õ?????????
library(metafor)
library(ggplot2)
library(glmulti)

#meta??????һ?????????????????о???ЧӦֵ???о??ڷ???


##????ЧӦֵ???????в??õ???log response ration (ROM)
##????????????:m1i,?????ľ?ֵ??sd1i???????ı?׼?n1i????????????��
##m2i?????յľ?ֵ??sd2i=???յı?׼?n2i=???յ?????��

d2<-escalc(measure="ROM",data=d1,m1i=treatment_mean,sd1i=treatment_sd,n1i=treatment_n,m2i=control_mean,sd2i=control_sd,n2i=control_n)

##?鿴????????ЧӦֵ?????ݣ???d2
View(d2)
##?鿴??????��??ЧӦֵ???о??ڷ?????ԭ???и?????ЧӦֵ???о??ڷ????Ĺ?ϵ
plot(yi~rr,data=d2)
plot(vi~var,data=d2)
##????ǰ???���ɾ?????????㲻????Ҫ?ı?��
library(dplyr)
d2<- select(d2, -rr,-var,-treatment_mean,-treatment_n,-treatment_sd,-control_mean,-control_n,-control_sd)
View(d2)

write.csv(d2, file="d2.csv")


##########################??ͬ????ЧӦֵ?Ĺ?һ??ת??

dat <- escalc(measure="RR", ai=tpos, bi=tneg, ci=cpos, di=cneg, data=dat.bcg)

View(dat)




library(esc)

help(esc)

###??��??????
e1 <- esc_2x2(grp1yes = 30, grp1no = 50, grp2yes = 40,
              grp2no = 45, study = "Study 1")

### ??��?????? odds ratio
e2 <- esc_2x2(grp1yes = 30, grp1no = 50, grp2yes = 40, grp2no = 45,
              es.type = "or", study = "Study 2")
### tֵ
e3 <- esc_t(p = 0.03, grp1n = 100, grp2n = 150, study = "Study 3")

###??ֵ?? SD
e4 <- esc_mean_sd(grp1m = 7, grp1sd = 2, grp1n = 50, grp2m = 9, grp2sd = 3,
                  grp2n = 60, es.type = "logit", study = "Study 4")

mydat <- combine_esc(e1, e2, e3, e4)

View(mydat)



#Meta?????ڶ???: ???????а????о?????ЧӦֵ

##?ֱ?????????ЧӦģ?ͺͻ???ЧӦģ?ͼ??????а????о???ƽ??(?ۼ?)ЧӦֵ
##???��ݶ?Qt???????Լ????ж??Ƿ?Ҫ????Ӱ??????(???ͱ?��)

##?̶?ЧӦģ?ͣ?????rma?????ָ??method="FE"
##??ЧӦֵyi????С??????˳??????????(?Ǳ?Ҫ????)
d2<- d2[order(-d2$yi),] 
##?̶?ЧӦģ?????㣬ָ??method="FE"
fixed1<-rma(yi,vi, data=d2, method="FE")
##?鿴????
summary(fixed1)

##ɭ??ͼ
forest(fixed1,annotate=FALSE,cex=1,slab=NA)
abline(v=0, lty="solid",col="red") 
abline(v=coef(fixed1), lty="dotted",col="red") 

##????ЧӦģ?ͣ?ָ?????õķ???Ϊ????????????Ȼ??REML??Ҳ????ָ????????????
random1<-rma(yi,vi, data=d2, method="REML")
summary(random1)



par(mar=c(5, 6, 2, 3))##??????ͼ???????????ұ?Ե????

attach(d2)
fd3<- d2[order(-yi),] 
attach(fd3)
forest(yi, vi, annotate=FALSE, col="grey", slab=NA, xlab="Log response ratio", pch=20,efac=0,font=2,cex=1,psize=1,xlim=c(-10,10), lty=c("solid","blank"))
addpoly(random1, mlab=NA, efac=1,annotate=FALSE, cex=1)
addpoly(fixed1, mlab=NA, efac=1,annotate=FALSE, cex=1)
abline(v=coef(random1), lty="solid",col="red", lwd=2)  
abline(v=coef(fixed1), lty="solid",col="blue", lwd=2) 
abline(v=0, lty="dotted",col="red") 
kk<-1779
points(fd3$yi, kk:1, pch=19, cex=0.5)
### text(c(-6), 1800, c("overall effect size"),cex=1.5,font=2)









##��ģ?ͽ????Ա???ͼ???ֱ???ȡ��ģ?͵?ƽ??ЧӦֵ?ͷ??????ͼ

estimates <- c(coef(random1), coef(fixed1))
variances <- c(vcov(random1), vcov(fixed1))
labels <- c("Random effect model", "Fixed effect model")


forest(estimates, variances,slab=labels,ylim=c(0.8, 4.5),font=2,cex=1.5,psize=1,xlab="Effect size (log response ratio)")
text(c(-0.6,-0.1), 2.7, c("Model type", "Mean [95% CI]"),cex=1.5,font=2)


##????ĳһ??Ⱥ???ۼ?ЧӦֵ??subset???
##?絥?��???????group????ΪBirds??Mammalsʱ??Ӧ?????ݵ??ۼ?ЧӦֵ

r2<-rma(yi,vi, data=subset(d2,group=="Birds"), method="REML")
r3<-rma(yi,vi, data=subset(d2,group=="Mammals"), method="REML")

##?鿴ģ?ͽ???
summary(r2)


summary(r3)


####?õ?tau^2, I^2??ָ???ľ?ֵ??????????
confint(r2)


##?Խ?????ͼ?????ȷֱ???ȡ��??ģ?ͷֱ????ۼ?ЧӦֵ?ľ?ֵ?ͷ????Ĺ��?ֵ
estimates2 <- c(coef(r2), coef(r3))
variances2 <- c(vcov(r2), vcov(r3))
labels2 <- c("Birds", "Mammals")
forest(estimates2, variances2,slab=labels2,ylim=c(0.8, 4.5),font=2,cex=1.5,psize=1,xlab="Effect size (log response ratio)")
text(c(-0.62,-0.08), 2.7, c("Group", "Mean [95% CI]"),cex=1.5,font=2)











#Meta???????????????????ͱ?��??ģ?ʹ?????ЧӦģ??ת??Ϊ????ЧӦģ?ͣ?????????ĳЩӰ???????Ƿ???ЧӦֵ??????Ӱ??

##???ͱ?��Ϊ??????��ʱ?ķ???
##??ʾ???????У??��?ģ??r1?Ľ?????ͨ??summary(random1)?鿴????
##??ЧӦֵ??????????ָ??Qt(df = 1778) = 52841.2851, p-val < .0001
##˵?????ݵ??????Ժ?ǿ???б?Ҫ???????ͱ?��???????н??͡?
##?????ɷ???????????????Ⱥ(birds or mammal)??ЧӦֵ????Ӱ?죬????ͬ??????Ⱥ?ܴ??Ե?Ӱ?????ܲ?ͬ??
###?̶?ЧӦģ??
fr4<-rma(yi,vi, mods=~group,data=d2, method="FE")
summary(fr4)

fr5<-rma(yi,vi, mods=~group-1,data=d2, method="FE")
summary(fr5)

estimates_fr5 <- coef(summary(fr5))[,1]

## Birds ??Mammals???Եĵķ???
se_fr5 <- coef(summary(fr5))[,2]
variance_fr5<-se_fr5^2 


labels_fr5 <- c("Birds", "Mammals")
forest(
  estimates_fr5,
  variance_fr5,
  slab = labels_fr5,ylim=c(0.8, 4.5),
  font = 2,
  cex = 1.5,
  psize = 1,
  xlab = "Effect size (log response ratio)"
)
text(c(-0.54,-0.30), 2.7, c("Group", "Mean [95% CI]"),cex=1.5,font=2)
text(c(-0.4), 1.4, c("Qm= 47.46,df=1, P<0.0001"),cex=1.2,font=1,col="red")

dev.off() 








###????ЧӦģ??
r4<-rma(yi,vi, mods=~group,data=d2, method="REML")
summary(r4)


##???????У?ЧӦֵ??????????ָ?꣺QM(df = 1) = 0.1274, p-val = 0.7211
##˵??group?Ĳ?ͬˮƽ֮?䣨??Birds vs Mammals????ЧӦֵ????????????????��????Ⱥ?ܴ??Ե?Ӱ?????ƣ???????????

##ֱ?Ӳ鿴ģ?ͶԲ?ͬgroupˮƽ?Ĺ��?ֵ???ڽ??ͱ?��?????ϡ?-1??????
##ע?⣺??ģ?͵?Qmֵ?????壬ֻ???鿴ģ?Ͷ?group??ͬˮƽ??ƽ??ЧӦֵ?????????????Ĺ��Ƽ???

r5<-rma(yi,vi, mods=~group-1,data=d2, method="REML")
summary(r5)

##?��?ģ??r5?Ľ?????ͼ
##??ȡr5?Ĳ????��ƽ???

coef(summary(r5))

## Birds ??Mammals???Եĵ??ۼ?ЧӦֵ

estimates3 <- coef(summary(r5))[,1]

## Birds ??Mammals???Եĵķ???
se3 <- coef(summary(r5))[,2]
variance3<-se3^2 


labels3 <- c("Birds", "Mammals")
forest(
  estimates3,
  variance3,
  slab = labels3,ylim=c(0.8, 4.5),
  font = 2,
  cex = 1.5,
  psize = 1,
  xlab = "Effect size (log response ratio)"
  )
text(c(-0.65,-0.06), 2.7, c("Group", "Mean [95% CI]"),cex=1.5,font=2)
text(c(-0.275), 1.4, c("Qm= 0.1274,df=1,p=0.7211"),cex=1.2,font=1,col="red")

#### mmr1, mmr1_1 ??Ϊ??ˮƽ????ģ?ͣ?????????ʱ???ϳ???????????��ϰ

### mmr1<-rma.mv(yi,vi, mods=~group,data=d2, random=~1|reference/id,method="REML")

### mmr1_1<-rma.mv(yi,vi, mods=~group-1,data=d2, random=~1|reference/id,method="REML")


### ??mmr1_1ģ?͵Ľ?????ͼ
### estimates_mmr1_1 <- coef(summary(mmr1_1))[,1]

## Birds ??Mammals???Եĵķ???
### semmr1_1 <- coef(summary(mmr1_1))[,2]
### variance1_1<-semmr1_1^2 


### labels3 <- c("Birds", "Mammals")
### forest(
###  estimates_mmr1_1,
###  variance1_1,
###  slab = labels3,ylim=c(0.8, 4.5),
###  font = 2,
###  cex = 1.5,
###  psize = 1,
###  xlab = "Effect size (log response ratio)"
### )
## text(c(-0.94,-0.00), 2.7, c("Group", "Mean [95% CI]"),cex=1.5,font=2)
### text(c(-0.4), 1.4, c("Qm= 0.8088,df=1,p=0.3685"),cex=1.2,font=1,col="red")


##????????Ϊ��????��ʱ
##???磬?????????????У??˿??ܶȶ?ЧӦֵ??Ӱ??
r6<-rma(yi,vi, mods=~human_dens,data=d2, method="REML")
summary(r6)
##????????effect size=-0.2536-0.001*human_dens
##Qm=15.4975,P<0.0001
##??˵???˿??ܶȶ?ЧӦֵ??????Ӱ?죬
##?˿??ܶ?Խ?ߣ?ЧӦֵԽ?ͣ??????ԶԶ?????Ⱥ?ĸ???Ӱ??Խ??

##???ͱ?��Ϊ��????��ʱ????ͼ???ع?ͼ??
##ģ?Ͷ??˿??ܶȲ?ͬʱ??ЧӦֵ?Ĺ��?ֵ

preds <- predict(r6, newmods=c(0:700))
wi<- 1/sqrt(d2$vi)
size  <-0.8 + 3.0 * (wi - min(wi))/(max(wi) - min(wi))
plot(d2$human_dens, d2$yi, pch=19, cex=size, col="grey",ylab="",
     xlab="Human population density",
     las=1, bty="l", font=2,cex.lab=1.5)
lines(0:700, preds$pred)
lines(0:700, preds$ci.lb, lty="dashed")
lines(0:700, preds$ci.ub, lty="dashed")
abline(h=0, lty="dotted",col="red",lwd=2)
title(ylab="Effect size (log resposne ratio)", line=2, cex.lab=1.5)
text(c(500), 4.5, c("Qm=15.4975,P<0.0001"),cex=1.2,font=1,col="red")


############# ��????��??ЧӦֵ?Ĺ?ϵΪ??ֱ?߹?ϵʱ #######

fd <- read_excel("Benitez-Lopez_et_al._2017_Science.xlsx",na = "NA")
fd2<-subset(fd,group=="Birds")
fd2$logdist<-log(fd2$distance_km)
nlm1<-rma.mv(rr,samplingvar,mods=~logdist, random = list(~1|species,~1|study),method="REML",data=fd2)
summary(nlm1)

## ?Խ?????ͼ????
summary(fd2$logdist)
a<-seq(from = -4, to = 4.07, by = 0.01)

##????Ҫ?��Ƶ?x????ȷ????ΧҲ?ɲ???
## logd<-fd2$logdist
## logd <- na.omit(logd)
## a<-seq(min(logd), max(logd), length.out=10000)

preds <- predict(nlm1, newmods=a)
x=exp(a)
wi<- 1/sqrt(fd2$samplingvar)
wi <- na.omit(wi)
size  <-1.5+ 5.0 * (wi - min(wi))/(max(wi) - min(wi))

plot(fd2$distance_km, fd2$rr,type="n")
plot(fd2$distance_km, fd2$rr, axes=TRUE, xlab="Distance to hunter's access points (km)",ylab="Effect size (logRR)", cex.lab=1.2, type="n")
cols <- c("pink")
polygon(c(rev(x), x), c(rev(preds$ci.lb), preds$ci.ub), col =alpha(cols, 0.5), border = NA)
lines(x, preds$pred,col="red")
abline(h=0, lty="dotted",col="grey",lwd=3)
points(fd2$distance_km, fd2$rr, cex=size, col="blue")


##???رȽϣ?һ?????ص?ˮƽ????2??????ͬˮƽ֮???ıȽϣ?
## ʾ???????У?guild?ж???ˮƽ??Carn,Frug,Herb, Inver, Omn5??ˮƽ
table(d2$guild)

r7<-rma(yi,vi, mods=~guild,data=d2, method="REML")
summary(r7)

##??????ʾQM(df = 4) = 50.8778, p-val < .0001??
##????ͬguild֮????????????????????guild??????ˮƽ??Carn,Frug,Herb, Inver, Omn
##????????Щˮƽ֮???????????????ö??رȽϷ???

##??ͼ??ֱ?۲鿴??ͬˮƽ?Ĳ???
r8<-rma(yi,vi, mods=~guild-1,data=d2, method="REML")
summary(r8)
coef(summary(r8))
estimates4 <- coef(summary(r8))[,1]
se4 <- coef(summary(r8))[,2]
variances4<- se4^2
labels4 <- c("Carn", "Frug", "Herb", "Inver", "Omn")
forest(estimates4, variances4, slab=labels4, font=2,cex=1.5,psize=1,
       xlim=c(-0.8,0.75),
       xlab="Effect size (log response ratio)")
text(c(-0.7,0.48), 6.3, c("Group", "Mean [95% CI]"),cex=1.5,font=2)
text(c(-0.1), 6.3, c("Qm=50.87,df=4,P<0.0001"),cex=1.3,font=1,col="red")

##?鿴??????֪??????Carn????Ϊ??׼ֵ(???????еĽؾ?)??????ˮƽ?ֱ??????Ƚϡ?
##???????У???һ?ж?Ӧ??Ϊ??Carn?Ĺ��?ֵ, ??2-5?зֱ?Ϊ??Frug, Herb, Inver Omn??Carn?ԱȺ??Ĺ��?ֵ.
##???磬Frug??ֵΪ??-0.0974(?ؾ??��?ֵ)+(-0.2232)(???????е?2?й��?ֵ)=-0.3206
##ͬ????Omn??ֵΪ-0.0974(?ؾ??��?ֵ)+0.0984(???????е?5?й��?ֵ)=0.001
##???????Ƚ?Frug??Carn??��??ˮƽ?Ĳ????Ƿ?????????ô??
anova(r8, L=c(1,-1,0,0,0))
##???????Ƚ?Herb??Omn??��??ˮƽ?Ĳ????Ƿ?????????ô??
anova(r8, L=c(0,0,1,0,-1))
##???????Ƚ?Inver??Omn??��??ˮƽ?Ĳ????Ƿ?????????ô??
anova(r8, L=c(0,0,0,1,-1))



###?????????ã???????ĳһ???ص?Ӱ?죺
View(d2)

r9<-rma(yi,vi, mods=~guild+group,data=d2, method="REML")
summary(r9)

##?鿴??????֪????ģ???У?guild=Carns,??group="Birds"ʱ????Ϊ??׼ֵ(???ؾ?)??
##????ˮƽ???????Ƚ?
##??ô????????guild???Զ?ЧӦֵ??Ӱ?죬??ô??
anova(r9, btt=2:5)
##????????group???Զ?ЧӦֵ??Ӱ?죬??ô??
anova(r9, btt=6)

##????????
r10<-rma(yi,vi, mods=~guild+human_dens+guild:human_dens,data=d2, method="REML")
summary(r10)


anova(r10, btt=2:4)
##guild???��?ЧӦֵ??Ӱ??
anova(r10, btt=2:5)
##human_dens???��?ЧӦֵ??Ӱ??
anova(r10, btt=6)
##guild??human_dens?Ľ??????????ö?ЧӦֵ??Ӱ??
anova(r10, btt=7:10)




#Meta???????Ĳ???ģ?????ϣ??ж??????Ŀɿ???. ע?⣬Ŀǰ????©??ͼ?⣬ģ?????Ϲ???ֵֻ??????rma???????rma.mv????в?????
##????Ҫ??ģ??r11??r22????ģ?????ϣ?
r11<-rma(yi,vi, data=subset(d2,group=="Birds"), method="REML")
r22<-rma(yi,vi, data=subset(d2,group=="Mammals"), method="REML")
##????ƫ????????--©??ͼ
funnel(r11,main="For birds")
funnel(r22,main="For mammals")

####??ͬ???͵?©??ͼ
funnel(r11, main="Standard Error")
funnel(r11, yaxis="vi", main="Sampling Variance")
funnel(r11, yaxis="seinv", main="Inverse Standard Error")
funnel(r11, yaxis="vinv", main="Inverse Sampling Variance")


##©??ͼ????2
funnel(r11,yaxis="seinv",level=c(90, 95, 99),ylab="Precision (1/SE)" ,shade=c("white", "gray", "darkgray"), refline=0)
funnel(r22,yaxis="seinv",level=c(90, 95, 99),ylab="Precision (1/SE)" ,shade=c("white", "gray", "darkgray"), refline=0)
##??©??ͼ?ĶԳ??Խ??м???(Egger's regression test for funnel plot asymmetry)
##P>0.05??????©??ͼ?Գƣ??ܷ???ƫ???Ե?Ӱ????С????û?з???ƫ????

regtest(r11, model="rma") ##Egger's regression test for funnel plot asymmetry,for the meta-analytic models
regtest(r22, model="rma")


###Trim and fill method
###?ο????ף?Duval, S. J., & Tweedie, R. L. (2000a). 
###Trim and fill: A simple funnel-plot-based method 
###of testing and adjusting for publication bias 
###in meta-analysis. Biometrics, 56(2), 455?C463. 
###ע???˷?????ʵ??Ӧ???в???????

summary(r11)
t<-trimfill(r11)
t
funnel(t)


##qq??̬ͼ
qqnorm(r11)


##?״?ͼ
radial(r11)
radial(r22)

##????ʽ????ͼ??һ????
plot(r11)



##ʧ??ȫϵ??????
##ʧ??ȫϵ?????ڼ??鷢??ƫ???ԣ?????ѡģ???޹أ?ֻ??yi??vi?й?
##Rosenthal fail safe number???ٽ?ֵΪ5k+10,????kΪ???????????о??ĸ?????????5k+10?????޷???ƫ????
fsn(yi,vi, data=d2) 



##?鿴?????ļ???????ʧ??ȫϵ?????÷?
?fsn


##?жϵ????о?????????????Ӱ?죬?ۼƼ??뷨?????μ???һ??????
rcu <- cumul(r11)
forest(rcu)


##?жϵ????о?????????????Ӱ?죬ȥ??????ÿ??ȥ??һ??????

inf<-influence(r11)
plot(inf, plotdfb=T)







###Meta?????е?????????
## ????????1??SD????
##????Ӧ????????ЧӦֵ???о??ڷ????????ı?��
##????ԭ?????д????Ͷ??յ?SD????ȱʧֵ????ô???Զ???SDֵ???????��?
fd0 <- read.csv("Benitez-Lopez_Hunting_Science.csv")
View(fd0)
##Ȼ????impute_SD??????ȱʧֵ???й��?
library(metagear)
##????Bracken1992
##?ֱ????봦???Ͷ??յľ?ֵ?ͱ?׼????Ӧ??????????ѡ?????㷽??
##Bracken1992??
fd1<-impute_SD(fd0, columnSDnames=c("SD_hunted","SD_control"), columnXnames=c("Abund_hunted", "Abund_control"), method = "Bracken1992")
View(fd1)
##?鿴?????ļ???????????????
??impute_SD




##????????2????????ȡ????(bootstrap)???ۼ?ЧӦֵ??????????
## ??????????Ϊ??
##????boot??????
library(boot)
##bootstrap????1
##????boot???????һ?β??????κθĶ?
boot.func1 <- function(dat, indices) {
  res <- rma(yi, vi, data=dat, subset=indices, method="REML")
  c(res$beta, res$se^2)}

##????boot.func1??????????ȡ??????
BS_CI_birds1<- boot(dat=subset(d2,group=="Birds"), boot.func1, R=500)
##?鿴??ȡ?????????䣬
##ע?⣺?????и?????5?????????䣬?ֱ?ΪNormal??Basic,Studentized??Percentile??BCa
##ѡ??Percentile???????伴??
boot.ci(BS_CI_birds1)

##bootstrap????2
##????boot???????һ?β??????κθĶ?
boot.func2 <- function(dat, indices) {
  
  res <- try(rma(yi, vi, data=dat, subset=indices), silent=TRUE)
  
  if (is.element("try-error", class(res))) {
    NA
  } else {
    c(coef(res), vcov(res), res$tau2, res$se.tau2^2)
  }
}

##????boot.func2??????????ȡ??????
BS_CI_birds2<- boot(dat=subset(d2,group=="Birds"), boot.func2, R=500)

##?鿴??ȡ?????????䣬
##ע?⣺?????и?????5?????????䣬?ֱ?ΪNormal??Basic,Studentized??Percentile??BCa
##ѡ??Percentile???????伴??
##?÷??????ɶ?tau^2?ľ?ֵ????????????????ȡ???��ƣ?????index=3:4????
boot.ci(BS_CI_birds2,index=1:2)

###????????3??ģ??ѡ?񣺴??ڶ?ģ????ѡ??????ģ??
##rma?????µ?ģ??ѡ??
##ע?⣺????һ??????????κ??޸?
rma.glmulti <- function(formula, data, ...) { rma(formula, vi, data=data, method="ML", ...)} ##?˾?????????κ??޸?
##????ȫģ??
modelselection<- glmulti(yi ~ body_mass+distance+human_dens+biome, 
                         data=subset(d2,group=="Birds"), level=1, fitfunction=rma.glmulti, crit="aicc", confsetsize=100)
##??????ģ?͵?AICcֵ??????ͼ
plot(modelselection)

##????????Ӱ????????????ģ???е?Ȩ??
modelweights<- weightable(modelselection)
modelweights
##?鿴AICcֵ???͵?ģ?ͽ???
summary(modelselection@objects[[1]])

##????????ģ?ͣ???ʱ??????ģ?Ͳ?ֹһ?????????ж???ģ????AICcֵ??AICcֵ???͵?ģ?͵?AICc??ֵ<2
bestmodelweights<- modelweights[modelweights$aicc <= min(modelweights$aicc) + 2,]

##?鿴????Ӱ????????????ģ?ͼ??е?Ȩ??
bestmodelweights
##??ͼ???鿴????Ӱ????????????ģ???е?Ȩ??
plot(modelselection, type="s")

 ##????????Ӱ????????ģ?ͼ?Ȩ???Ĳ????��?ֵ??????Ҫ?ԣ???importance>0.8Ϊ???ޣ?
##?????????ȡ??ģ?͵Ĳ????��?ֵ????һ?δ??벻???κθĶ?
setOldClass("rma.uni")
setMethod('getfit', 'rma.uni', function(object, ...) {
  if (object$test=="z") {
    cbind(estimate=coef(object), se=sqrt(diag(vcov(object))), df=Inf)
  } else {
    cbind(estimate=coef(object), se=sqrt(diag(vcov(object))), df=object$k-object$p)
  }
})

##?鿴????????ģ?ͼ?Ȩ???Ĳ????��?ֵ??????Ҫ?ԣ???importance>0.8Ϊ???ޣ?
round(coef(modelselection), 4)







##????????4??????meta????ģ??--?ֲ㣨Ƕ?ף?ģ?ͷ???
###hierarchical meta-analysis
##?ֲ㣨Ƕ?ף?ģ?ͣ?��??ͬһ?о??Ĳ?ͬ?????о????????ܱ˴????أ??????У???idǶ????reference֮??
##?ֲ?ģ??Ҫ????rma.mv??????????��???��?ַ???????????Ȼ??(ML)??????????????Ȼ??(REML)
##ע??????????Ҫ??idת??Ϊ????
d2$id<-as.factor(d2$id)
##????2??д????????ͬ

mr1<-rma.mv(yi,vi, mods=~biome,data=subset(d2,group=="Birds"), random=~1|reference/id,method="ML")
mr2<-rma.mv(yi,vi, mods=~biome,data=subset(d2,group=="Birds"), random=list(~1|reference/id),method="ML")

summary(mr1)
summary(mr2)



##?ֲ㣨Ƕ??ģ?ͣ????˰?????idǶ????reference֮??
mr6<-rma.mv(yi,vi, mods=~human_dens,data=subset(d2,group=="Birds") , random=~1|reference/id,method="ML")
summary(mr6)

##Ҳ????ͬʱ????????????????
mr7<-rma.mv(yi,vi, mods=~human_dens,data=subset(d2,group=="Birds"), random = list(~1|id,~1|species,~1|reference),method="ML")
summary(mr7)

##?Ա??Ƿ????Ƿֲ?ʱģ?ͽ????ı仯
##???ֲ?ģ???????ٶȽ?????????ֻ?????????ݽ???��ϰ
mm1<-rma(yi,vi, mods=~biome,data=subset(d2,group=="Birds"), method="ML")
hmm1<-rma.mv(yi,vi, mods=~biome,data=subset(d2,group=="Birds"), random=~1|reference/id,method="ML")
summary(mm1)
summary(hmm1)




##?ֲ?ģ????һ??ģ?ͶԲ?ͬ??ȺЧӦֵ?��?ֵ?ĶԱ?
mm2<-rma(yi,vi, mods=~biome-1,data=subset(d2,group=="Birds"), method="ML")
hmm2<-rma.mv(yi,vi, mods=~biome-1,data=subset(d2,group=="Birds"), random=~1|reference/id,method="ML")
summary(mm2)
summary(hmm2)

##rma.mv?????µ?ģ??ѡ?񣬷ֲ㣨Ƕ?ף?ģ??ѡ??
##?ֲ㣨Ƕ?ף?ģ??ѡ??????
##???ȶ???ģ??ѡ??????rma.glmulti??ע????һ?δ??벻?????κ??޸?
rma.glmulti <- function(formula, data, V, random,...) {
  do.call("rma.mv", list(as.formula(paste(deparse(formula))), V = as.name(V), random = as.name(random), data = data,  method = "ML", ...))
}


d2$id<-as.factor(d2$id)
##?????ֲ?????
random_effect <- list(~1|reference/id,~1|species)
##????full model
modelselection2 <- glmulti(yi ~ guild+biome+body_mass, V = "vi", random="random_effect", data=subset(d2,group=="Birds"), level = 1, method = "h", fitfunction = rma.glmulti, crit = "aicc", confsetsize =32)
##?Ը???ģ?͵?AICֵ??????ͼ
plot(modelselection2)
##?鿴????ģ????????ģ??
print(modelselection2)
##??ģ?Ͱ?AICcֵ????
rank.models <- weightable(modelselection2)
##?鿴??ͬģ?͵?Ȩ??
rank.models
##?鿴????ģ??(??????AICcֵ??????2???ڵ?ģ??)
rank.models <- rank.models[rank.models$aicc <= min(rank.models$aicc) + 2, ]
rank.models
##?Բ?ͬ???ص???Ҫ????ͼ
plot(modelselection2,type="s")

##?鿴????ģ??Ȩ?صĸ????ز????��?
##?????????ȡ??ģ?͵Ĳ????��?ֵ??????һ?β???Ҫ?κ??޸?
setOldClass("rma.mv")
setMethod('getfit', 'rma.mv', function(object, ...) {
  if (object$test=="z") {
    cbind(estimate=coef(object), se=sqrt(diag(vcov(object))), df=Inf)
  } else {
    cbind(estimate=coef(object), se=sqrt(diag(vcov(object))), df=object$k-object$p)
  }
})

##????????鿴????ģ??Ȩ?صĸ????ز????��?
round(coef(modelselection2), 4)

##rma.mvģ???£?©??ͼ????Ŀǰ?޷???regtest,??ranktest?Ը?ģ???µ?©??ͼ?ĶԳ??Խ??ж?��????
mr3<-rma.mv(yi,vi, mods=~human_dens,data=subset(d2,group=="Birds"), random=~1|reference/id,method="ML")
funnel(mr3,yaxis="seinv",level=c(90, 95, 99),ylab="Precision (1/SE)" ,shade=c("white", "gray", "darkgray"), refline=0)


##????????5,ɭ??ͼ???Ż?
##?̶?ЧӦģ????????ЧӦģ?ͶԶ԰???2??????????????
## ?̶?ЧӦģ??
dat <- escalc(measure="RR", ai=tpos, bi=tneg, ci=cpos, di=cneg, data=dat.bcg)
fixed11<- rma(yi, vi, method="FE", data=dat)
forest(fixed11, main="Fixed effect model")
random11<- rma(yi, vi, data=dat)
## ?̶?ЧӦģ??
forest(random11, main="Random effect model")
View(dat)

forest(random11, xlim=c(-18, 6), slab = paste(dat$author, dat$year),
       ilab=cbind(dat$tpos, dat$tneg, dat$cpos, dat$cneg),
       ilab.xpos=c(-10,-8,-6,-4), cex=1.2, ylim=c(-2, 16),
       xlab="effect size (ln odds ratio)", mlab="",font=2, psiz=1)
text(-18, -0.7, pos=4, cex=1.2,font=3, bquote(paste("Heterogeneity test: Qt = ",
                                                    .(formatC(random11$QE, digits=2, format="f")), ", df = ", .(random11$k - random11$p),
                                                    ", P = ", .(formatC(random11$QEp, digits=2, format="f")), "; ", I^2, " = ",
                                                    .(formatC(random11$I2, digits=1, format="f")), "%")))
text(-18, -1.7, pos=4, cex=1.2,font=3, 
     bquote(paste("Test of overall effect: Z = ",.(formatC(random11$zval, digits=4, format="f")), 
                  ", P = ", .(formatC(random11$pval, digits=4, format="f")))))

text(c(-10,-8,-6,-4), 15, c("+", "-", "+", "-"),cex=1.2,font=2)
text(c(-9,-5), 15.5, c("Yes", "No"),cex=1.2,font=2)
text(-18, 15, "Study ID", cex=1.2,font=2, pos=4)
text(6, 15, "Mean [95% CI]", cex=1.2,font=2,pos=2)

##????annotate=FALSE??ʹforestͼ??ЧӦֵ??ֵ????????????????ʧ
##????ɭ??ͼ?????ο???ַ
##https://www.rdocumentation.org/packages/metafor/versions/1.9-9/topics/forest.default

##?鿴?о??䷽??tau^2????Ȼֵ????????ʵ?????????б??��??ټ????μ?science???????¸????е?ͼ??
profile(r2, xlim=c(0,5), steps=50)
##��ϰ????????

